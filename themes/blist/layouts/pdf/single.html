{{ define "main" }}
<div class="container mx-auto">
  <div class="flex items-center mb-8 mt-10 px-4">
    <h1 class="text-4xl font-bold text-customGreen mr-4">{{ .Title }}</h1>
    <div class="h-1 bg-customGreen flex-grow"></div>
  </div>
</div>
<div class="bg-white p-6 px-10 rounded-lg shadow-lg flex flex-col md:flex-row justify-center" style="min-height: 80vh;">
    <div class="overflow-x-auto w-full md:w-2/3">
        <table class="w-full bg-white border border-gray-200">
            <thead>
                <tr>
                    <th class="px-2 py-2 bg-customGreen text-white" style="width: 70%;">Judul</th>
                    <th class="px-4 py-2 bg-customGreen text-white" style="width: 30%;">Tipe File</th>
                </tr>
            </thead>
            <tbody>
                {{ range .Params.items }}
                <tr class="cursor-pointer hover:bg-gray-100" onclick="showPreview('{{ .file }}', '{{ .title }}', this)" data-file="{{ .file }}">
                    <td class="border px-2 py-2">{{ .title }}</td>
                    <td class="border px-4 py-2">PDF</td>
                </tr>
                {{ end }}
            </tbody>
        </table>
    </div>
    <div class="mt-6 md:mt-0 md:ml-6 flex flex-col items-center justify-between bg-gray-200 p-6 rounded-lg w-72 h-96 md:mx-0 mx-auto">
        <div class="text-xl font-semibold mb-4">Preview</div>
        <div id="pdfPreview" class="w-full h-64 bg-white rounded mb-4 overflow-hidden flex items-center justify-center">
            <canvas id="pdfCanvas" class="max-w-full max-h-full object-contain hidden"></canvas>
            <div id="previewPlaceholder" class="text-gray-500">
                Pilih dokumen untuk preview
            </div>
        </div>
        <div class="flex space-x-4 mt-auto">
            <button id="viewBtn" onclick="viewPdf()" class="bg-customGreen text-white px-4 py-2 rounded flex items-center opacity-50 cursor-not-allowed" disabled>
                <i class="fas fa-eye mr-2"></i> Lihat
            </button>
            <button id="downloadBtn" onclick="downloadPdf()" class="bg-customGreen text-white px-4 py-2 rounded flex items-center opacity-50 cursor-not-allowed" disabled>
                <i class="fas fa-download mr-2"></i> Unduh
            </button>
        </div>
    </div>
</div>

<script type="module">
import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.mjs';

// Set worker path
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.mjs';

let currentPdfUrl = '';
let currentPdfTitle = '';
let selectedRow = null;

window.showPreview = async function(pdfUrl, title, row) {
    // Remove highlight from previously selected row
    if (selectedRow) {
        selectedRow.classList.remove('bg-green-100');
    }
    
    // Highlight current row
    row.classList.add('bg-green-100');
    selectedRow = row;
    
    currentPdfUrl = pdfUrl;
    currentPdfTitle = title;
    
    const canvas = document.getElementById('pdfCanvas');
    const placeholder = document.getElementById('previewPlaceholder');
    const viewBtn = document.getElementById('viewBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    if (pdfUrl) {
        try {
            // Load the PDF
            const loadingTask = pdfjsLib.getDocument(pdfUrl);
            const pdf = await loadingTask.promise;
            
            // Get the first page
            const page = await pdf.getPage(1);
            
            // Set canvas size to match PDF page size with scale to fit preview box
            const viewport = page.getViewport({scale: 1.0});
            const context = canvas.getContext('2d');
            
            // Calculate scale to fit preview box while maintaining aspect ratio
            const previewBox = document.getElementById('pdfPreview');
            const scaleWidth = previewBox.clientWidth / viewport.width;
            const scaleHeight = previewBox.clientHeight / viewport.height;
            const scale = Math.min(scaleWidth, scaleHeight) * 0.9; // 0.9 to add some padding
            
            const scaledViewport = page.getViewport({scale: scale});
            canvas.height = scaledViewport.height;
            canvas.width = scaledViewport.width;
            
            // Render PDF page into canvas context
            const renderContext = {
                canvasContext: context,
                viewport: scaledViewport
            };
            await page.render(renderContext);
            
            canvas.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            // Enable buttons and remove disabled styling
            viewBtn.disabled = false;
            downloadBtn.disabled = false;
            viewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } catch (error) {
            console.error('Error loading PDF:', error);
            canvas.classList.add('hidden');
            placeholder.classList.remove('hidden');
            placeholder.textContent = 'Error memuat preview PDF';
            
            // Disable buttons and add disabled styling
            viewBtn.disabled = true;
            downloadBtn.disabled = true;
            viewBtn.classList.add('opacity-50', 'cursor-not-allowed');
            downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    } else {
        canvas.classList.add('hidden');
        placeholder.classList.remove('hidden');
        placeholder.textContent = 'Preview tidak tersedia';

        // Disable buttons and add disabled styling
        viewBtn.disabled = true;
        downloadBtn.disabled = true;
        viewBtn.classList.add('opacity-50', 'cursor-not-allowed');
        downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

window.viewPdf = async function() {
    if (currentPdfUrl) {
        Fancybox.show([
            {
                src: currentPdfUrl,
                type: "pdf",
                caption: currentPdfTitle
            }
        ], {
            dragToClose: false
        });
    }
}

window.downloadPdf = function() {
    if (currentPdfUrl) {
        const link = document.createElement('a');
        link.href = currentPdfUrl;
        link.download = currentPdfTitle;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
</script>
{{ end }}
